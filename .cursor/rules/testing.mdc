---
description: when editing or running tests
globs:
alwaysApply: false
---
# Testing Guidelines

## Writing Tests

- Tests are written using [RSpec](mdc:https:/rspec.info)
- Test files should mirror the structure of `lib`
- All changes MUST be covered by corresponding tests, with all flow paths.
- If new files in the repository are created, run `git add -A` before running tests (otherwise `release_gem_spec.rb` will fail)
- Do not use `instance_variable_set` and `instance_variable_get` in tests, use mocking when needed
- Do not make changes to `release_gem_spec.rb` if not asked

### RSpec Style
- Rule of thumb is trying to have a 1:1 filename mapping between `lib/**/*.rb` and `spec/**/*_spec.rb`; sometimes this is not possible but should be justified (e.g integration tests), ask for guidance and explain rationale when deviating form the rule.
- Do not use focused tests feature (fit, fdescribe)
- Always name the `subject`, and name it after the closest concept (e.g. the method if testing a method, the return object if testing an object), and keep the name short.
- Keep `subject` close to its `describe`.
- Share `subject` when possible, making it parametric using `let`.
- Use `is_expected` instead of `expect(subject)`.

### Test types
- Integration tests (`spec/datadog/*/contrib/`): avoid mocking, realistic apps, real dependencies.
- System tests (runs in CI: `.github/workflows/system-tests.yml`): Full-stack, high-level feature scenarios. (`docs/ForcingSystemTests.md`)
- Unit tests (all other tests): fast, isolated, mock dependencies.

## Running Tests

- Run core library tests: `bundle exec rake test:main`
- Run a specific test/file from core library tests: `bundle exec rspec <relative path to the file>`
  - You can't run `shared_examples` directly, run the tests that use it instead.
- Re-run impacted tests after modifying `lib/` or `ext/`

## Appraisal Groups

- Dependency configurations are managed with [Appraisal](mdc:https:/github.com/thoughtbot/appraisal), under `appraisal/`.
- When editting `appraisal/`, run `bundle exec rake dependency:generate` to regenerate `gemfiles/`.
- Install dependencies with `bundle exec rake dependency:lock`.
- More info `docs/DevelopmentGuide.md#working-with-different-dependencies`.

## Example

- Idiomatic unit test example:
```ruby
module Datadog
  class ExampleBucket
    def initialize(rate, max_tokens = rate)
      @rate = rate
      @max_tokens = max_tokens
      @tokens = max_tokens
      @last_refill = Utils::Time.get_time
    end

    def allow?(size = 1)
      now = Utils::Time.get_time
      elapsed = now - @last_refill
      @tokens = [@tokens + (@rate * elapsed), @max_tokens].min
      @last_refill = now

      return false if @tokens < size

      @tokens -= size
      true
    end
  end
end
```
- Respective test:
```ruby
require 'spec_helper'

RSpec.describe Datadog::ExampleBucket do
  subject(:bucket) { described_class.new(rate, max_tokens) }

  let(:rate) { 1 }
  let(:max_tokens) { 10 }

  describe '#allow?' do
    subject(:allow?) { bucket.allow?(size) }

    before do
      allow(Datadog::Core::Utils::Time).to receive(:get_time).and_return(0)
    end

    context 'and tokens consumed' do
      before { bucket.allow?(max_tokens) }

      context 'after 1 second' do
        before do
          allow(Datadog::Core::Utils::Time).to receive(:get_time).and_return(1)
        end

        context 'with message the same size of or smaller than replenished tokens' do
          let(:size) { rate }

          it { is_expected.to eq(true) }
        end
      end
    end
  end
end
```
