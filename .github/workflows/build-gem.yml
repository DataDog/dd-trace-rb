name: Build gem

on: # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      push:
        description: Push gem
        required: true
        type: boolean
        default: true
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

# Default permissions for all jobs
permissions: {}

env:
  GEM_HOST: 'https://rubygems.pkg.github.com/DataDog'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        type:
          - final
          - dev
    runs-on: ubuntu-22.04
    name: Build gem (${{ matrix.type }})
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
      - uses: ruby/setup-ruby@0481980f17b760ef6bca5e8c55809102a0af1e5a # v1.263.0
        with:
          ruby-version: '3.2'
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically
      - name: Patch version
        if: ${{ matrix.type != 'final' }}
        env:
          GHA_RUN_ID: ${{ github.run_id }}
          GIT_REF: ${{ github.ref }}
          GIT_SHA: ${{ github.sha }}
        run: |
          .gitlab/patch_gem_version.sh gha "$GHA_RUN_ID" "$GIT_REF" "$GIT_SHA";

      - name: Patch gem host
        if: ${{ matrix.type != 'final' }}
        run: |
          # Patch in GEM_HOST
          sed datadog.gemspec -i -e "s,^\([\t ]*spec\.metadata\['allowed_push_host'\]\) *= *,\1 = \'${GEM_HOST}\' # ,"

          # Test result
          grep -e allowed_push_host datadog.gemspec
      - name: Build gem
        run: bundle exec rake build
      - name: List gem
        run: |
          find pkg
      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: 'datadog-gem-${{ matrix.type }}-gha${{ github.run_id }}-g${{ github.sha }}'
          path: 'pkg/*.gem'
  test:
    strategy:
      fail-fast: false
      matrix:
        type:
          - final
          - dev
    runs-on: ubuntu-22.04
    name: Test gem
    needs:
      - build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: 'datadog-gem-${{ matrix.type }}-gha${{ github.run_id }}-g${{ github.sha }}'
          path: 'pkg'
      - name: List gem
        run: |
          find pkg
      - uses: ruby/setup-ruby@0481980f17b760ef6bca5e8c55809102a0af1e5a # v1.263.0
        with:
          ruby-version: '3.2'
      - name: Install gem
        run: |
          gem install pkg/*.gem
  push:
    strategy:
      fail-fast: false
      matrix:
        type:
          - dev
    runs-on: ubuntu-22.04
    name: Push gem
    needs:
      - test
    if: ${{ inputs.push }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: 'datadog-gem-${{ matrix.type }}-gha${{ github.run_id }}-g${{ github.sha }}'
          path: 'pkg'
      - name: List gem
        run: |
          find pkg
      - name: Set up GitHub Packages authentication
        run: |
          mkdir -p ~/.gem
          cat > ~/.gem/credentials <<'CREDENTIALS'
          ---
          :github: Bearer ${{ secrets.GITHUB_TOKEN }}
          CREDENTIALS
          chmod 0600 ~/.gem/credentials
      - name: Push gem
        run: |
          find pkg -name '*.gem' | while read -r gem; do
            echo "=== pushing '${gem}'"
            gem push --key github --host ${{ env.GEM_HOST }} "${gem}"
          done
      - name: Clean up credentials
        run: |
          rm -rvf ~/.gem/credentials

  complete:
    name: Build Gem (complete)
    runs-on: ubuntu-24.04
    needs:
      - test
    steps:
      - run: echo "DONE!"
