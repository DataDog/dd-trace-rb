name: Bump datadog gem version

on: # yamllint disable-line rule:truthy
  repository_dispatch:
    types: [bump-gem-version]
  workflow_dispatch:
    inputs:
      dry-run:
        description: Skip PR creation and only show changes
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Default permissions for all jobs
permissions: {}

jobs:
  next-gem-version:
    if: github.ref_name == 'master'
    name: Prepare next gem version
    runs-on: ubuntu-24.04
    outputs:
      next_version: ${{ steps.next_version.outputs.next_version }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Set up Ruby
        uses: ruby/setup-ruby@a4effe49ee8ee5b8b5091268c473a4628afb5651 # v1.245.0
        with:
          ruby-version: "3.3.7"
      - run: bundle install
      - id: next_version
        run: |
          echo "next_version=$(bundle exec rake version:next)" >> "$GITHUB_OUTPUT"

  update-version-file:
    if: ${{ github.ref_name == 'master' && github.event.inputs.dry-run != 'true' && github.event.client_payload.dry-run != 'true' }}
    name: Create Pull Request to update the version file
    runs-on: ubuntu-24.04
    needs:
      - next-gem-version
    permissions:
      contents: write
      pull-requests: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NEXT_VERSION: ${{ needs.next-gem-version.outputs.next_version }}.dev
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - name: Set up Ruby
        uses: ruby/setup-ruby@a4effe49ee8ee5b8b5091268c473a4628afb5651 # v1.245.0
        with:
          ruby-version: "3.3.7"
      - run: bundle install
      - name: Update version file
        run: |
          echo "Updating version to ${NEXT_VERSION}"
          bundle exec rake version:bump -- "${NEXT_VERSION}"
      - name: Create PR to master
        run: |
          JOB_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BRANCH_NAME="update-version-${NEXT_VERSION}"

          git checkout -b "${BRANCH_NAME}"

          git add lib/datadog/version.rb
          git commit -m "Update version to ${NEXT_VERSION}"

          git push origin "${BRANCH_NAME}"

          gh pr create \
            --base master \
            --head "${BRANCH_NAME}" \
            --title "Update version to ${NEXT_VERSION}" \
            --body "This is an auto-generated PR to update the version file from [here](${JOB_URL})." \
            --label "version"
